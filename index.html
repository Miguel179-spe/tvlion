<!DOCTYPE html>   
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consola TV IPTV</title>
  <style>
    :root {
      --primary-color: #ff4444;
      --secondary-color: #44ff44;
      --bg-dark: #0a0a0a;
      --bg-card: #1a1a1a;
      --bg-hover: #2a2a2a;
      --border-color: #333;
      --text-color: #fff;
      --text-muted: #888;
      --error-color: #ff4444;
      --success-color: #44ff44;
      --warning-color: #ffaa00;
    }
    
    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-dark);
      color: var(--text-color);
      display: flex;
      height: 100vh;
      overflow: hidden;
      cursor: default;
      user-select: none;
      -webkit-user-select: none;
    }
    
    /* Layout Principal */
    .tv-container {
      display: flex;
      width: 100%;
      height: 100vh;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
    }
    
    .sidebar {
      width: 280px;
      background: rgba(30, 30, 30, 0.95);
      border-right: 2px solid var(--border-color);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
      z-index: 100;
    }
    
    .sidebar.hidden {
      transform: translateX(-100%);
    }
    
    .content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    /* Header TV */
    .tv-header {
      background: linear-gradient(90deg, #1a1a1a 0%, #2a2a2a 100%);
      padding: 15px 25px;
      border-bottom: 2px solid var(--primary-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .tv-logo {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary-color);
      text-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
    }
    
    .tv-info {
      display: flex;
      gap: 20px;
      font-size: 14px;
      color: var(--text-muted);
    }
    
    /* Barra de b√∫squeda */
    .search-container {
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-color);
      position: relative;
    }
    
    .search-box {
      width: 100%;
      padding: 10px 15px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: white;
      font-size: 14px;
    }
    
    .search-box:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    
    /* Navegaci√≥n TV */
    .nav-section {
      padding: 20px 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .nav-title {
      padding: 0 20px 15px 20px;
      font-size: 16px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      margin: 2px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
      position: relative;
    }
    
    .nav-item:hover {
      background: var(--bg-hover);
    }
    
    .nav-item.focused {
      background: var(--primary-color);
      color: white;
      transform: scale(1.02);
      border-color: var(--secondary-color);
      box-shadow: 0 0 15px rgba(255, 68, 68, 0.3);
    }
    
    .nav-item.active {
      background: var(--bg-hover);
      border-left: 4px solid var(--primary-color);
    }
    
    .nav-item.has-submenu::after {
      content: '‚ñ∂';
      position: absolute;
      right: 15px;
      color: var(--text-muted);
      font-size: 12px;
    }
    
    .nav-item.focused.has-submenu::after {
      color: white;
    }
    
    .nav-icon {
      width: 24px;
      height: 24px;
      margin-right: 12px;
      filter: brightness(0.8);
    }
    
    .nav-item.focused .nav-icon {
      filter: brightness(1);
    }
    
    /* Submen√∫s */
    .submenu {
      position: fixed;
      left: 280px;
      top: 0;
      width: 280px;
      height: 100%;
      background: rgba(40, 40, 40, 0.98);
      border-right: 2px solid var(--border-color);
      z-index: 99;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    
    .submenu.active {
      transform: translateX(0);
    }
    
    .submenu-header {
      padding: 15px 20px;
      background: rgba(30, 30, 30, 0.95);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .submenu-back {
      background: none;
      border: none;
      color: var(--primary-color);
      font-size: 18px;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
    }
    
    .submenu-back:hover {
      background: rgba(255, 68, 68, 0.2);
    }
    
    .submenu-title {
      font-size: 18px;
      font-weight: bold;
    }
    
    .submenu-items {
      flex: 1;
      padding: 10px 0;
      overflow-y: auto;
    }
    
    .submenu-item {
      padding: 12px 20px;
      margin: 2px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }
    
    .submenu-item:hover {
      background: var(--bg-hover);
    }
    
    .submenu-item.focused {
      background: var(--primary-color);
      color: white;
      transform: scale(1.02);
      border-color: var(--secondary-color);
      box-shadow: 0 0 15px rgba(255, 68, 68, 0.3);
    }
    
    /* Grid de Canales TV */
    .channels-grid {
      flex: 1;
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
      overflow-y: auto;
      background: rgba(10, 10, 10, 0.8);
    }
    
    .channel-card {
      background: linear-gradient(145deg, #1a1a1a, #252525);
      border-radius: 12px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      display: flex;
      flex-direction: column;
      height: 140px;
      justify-content: space-between;
      position: relative;
      overflow: hidden;
    }
    
    .channel-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--primary-color);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    
    .channel-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .channel-card.focused {
      transform: scale(1.05);
      border-color: var(--primary-color);
      box-shadow: 0 0 20px rgba(255, 68, 68, 0.4);
      z-index: 10;
    }
    
    .channel-card.focused::before {
      transform: scaleX(1);
    }
    
    .channel-card.playing {
      border-color: var(--secondary-color);
      box-shadow: 0 0 15px rgba(68, 255, 68, 0.3);
    }
    
    .channel-logo {
      width: 100%;
      height: 70px;
      object-fit: contain;
      margin-bottom: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      padding: 5px;
    }
    
    .channel-name {
      font-size: 13px;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: var(--text-color);
    }
    
    /* Reproductor TV */
    .video-container {
      position: relative;
      background: #000;
      transition: all 0.3s ease;
    }
    
    #videoPlayer {
      width: 100%;
      height: 0;
      background: #000;
      transition: all 0.3s ease;
    }
    
    #videoPlayer.active {
      height: 300px;
    }
    
    #videoPlayer.fullscreen-mode {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1000;
    }
    
    /* Temporizador Modo Cine - MEJORADO (20 segundos) */
    .fullscreen-timer {
      position: fixed;
      top: 30px;
      right: 30px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      z-index: 1001;
      font-size: 16px;
      display: none;
      border: 2px solid var(--primary-color);
    }
    
    .fullscreen-timer.show {
      display: block;
    }
    
    /* Estados de Carga y Error */
    .loading {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
      font-size: 16px;
    }
    
    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% { color: rgba(255,255,255,0); text-shadow: .25em 0 0 rgba(255,255,255,0), .5em 0 0 rgba(255,255,255,0); }
      40% { color: white; text-shadow: .25em 0 0 rgba(255,255,255,0), .5em 0 0 rgba(255,255,255,0); }
      60% { text-shadow: .25em 0 0 white, .5em 0 0 rgba(255,255,255,0); }
      80%, 100% { text-shadow: .25em 0 0 white, .5em 0 0 white; }
    }
    
    .error {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px;
      color: var(--error-color);
      font-size: 16px;
    }
    
    /* Notificaciones TV */
    .tv-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(30, 30, 30, 0.95);
      border-left: 4px solid var(--primary-color);
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      z-index: 1500;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      max-width: 300px;
    }
    
    .tv-notification.show {
      transform: translateX(0);
    }
    
    .tv-notification.success {
      border-left-color: var(--success-color);
    }
    
    .tv-notification.error {
      border-left-color: var(--error-color);
    }
    
    .tv-notification.warning {
      border-left-color: var(--warning-color);
    }
    
    /* Modo Cine */
    .cinema-controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      padding: 15px;
      border-radius: 25px;
      display: none;
      gap: 10px;
      z-index: 1001;
    }
    
    .control-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      padding: 10px 15px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .control-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .control-btn.primary {
      background: var(--primary-color);
    }
    
    /* Scrollbar Personalizado */
    .channels-grid::-webkit-scrollbar,
    .submenu-items::-webkit-scrollbar {
      width: 8px;
    }
    
    .channels-grid::-webkit-scrollbar-track,
    .submenu-items::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    
    .channels-grid::-webkit-scrollbar-thumb,
    .submenu-items::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }
    
    /* Responsive TV */
    @media (max-width: 768px) {
      .sidebar {
        width: 220px;
      }
      
      .submenu {
        left: 220px;
        width: 220px;
      }
      
      .channels-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
      
      .tv-header {
        padding: 12px 15px;
      }
      
      .tv-logo {
        font-size: 20px;
      }
    }
    
    @media (max-width: 480px) {
      .tv-container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
        max-height: 40vh;
      }
      
      .submenu {
        left: 0;
        top: 40vh;
        width: 100%;
        height: 60vh;
      }
      
      .channels-grid {
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      }
      
      .channel-card {
        height: 120px;
      }
    }
  </style>
</head>
<body>
  <div class="tv-container">
    <!-- Panel Lateral -->
    <div class="sidebar">
      <!-- Barra de b√∫squeda -->
      <div class="search-container">
        <input type="text" class="search-box" id="searchBox" placeholder="Buscar canales...">
      </div>
      
      <div class="nav-section">
        <div class="nav-title">Navegaci√≥n</div>
        <div class="nav-item focused active" data-url="https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/All%20Channels.m3u">
          <span>üì∫</span>
          <span>All Channels</span>
        </div>
        <div class="nav-item" data-url="https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Sports%20Channels.html">
          <span>ü§º</span>
          <span>Sports Channels</span>
        </div>
        <div class="nav-item" data-url="https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Premium%20Channels.html">
          <span>üèÖ</span>
          <span>Premium Channels</span>
        </div>
        <div class="nav-item" data-url="https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/New%20Channels.html">
          <span>üÜï</span>
          <span>New Channels</span>
        </div>
      </div>
      
      <div class="nav-section">
        <div class="nav-title">Categor√≠as</div>
        <div class="nav-item has-submenu" data-submenu="deportes">
          <span>üåé</span>
          <span>Channels by Country</span>
        </div>
        <div class="nav-item has-submenu" data-submenu="noticias">
          <span>üì∫</span>
          <span>Channels by Category</span>
        </div>
        <div class="nav-item has-submenu" data-submenu="musica">
          <span>üìΩÔ∏è</span>
          <span>VIP channels</span>
        </div>
      </div>
    </div>

    <!-- Submen√∫s -->
    <div class="submenu" id="submenu">
      <div class="submenu-header">
        <button class="submenu-back" id="submenuBack">‚óÄ</button>
        <div class="submenu-title" id="submenuTitle">Submen√∫</div>
      </div>
      <div class="submenu-items" id="submenuItems">
        <!-- Los elementos del submen√∫ se cargar√°n din√°micamente -->
      </div>
    </div>

    <!-- √Årea Principal -->
    <div class="content-area">
      <!-- Header TV -->
      <div class="tv-header">
        <div class="tv-logo">DEV-IPTV</div>
        <div class="tv-info">
          <span id="currentCategory">Canales Estados Unidos</span>
          <span id="channelCount">0 canales</span>
        </div>
      </div>

      <!-- Video Player -->
      <div class="video-container">
        <video id="videoPlayer" controls preload="metadata"></video>
      </div>

      <!-- Grid de Canales -->
      <div class="channels-grid" id="channelsGrid">
        <div class="loading">Cargando canales</div>
      </div>
    </div>
  </div>

  <!-- Temporizador Modo Cine - MEJORADO (20 segundos) -->
  <div class="fullscreen-timer" id="fullscreenTimer">
    Modo cine en <span id="timerCountdown">20</span> segundos
  </div>

  <!-- Notificaciones -->
  <div class="tv-notification" id="notification">
    <div id="notificationMessage">Mensaje de notificaci√≥n</div>
  </div>

  <!-- Controles Modo Cine -->
  <div class="cinema-controls" id="cinemaControls">
    <button class="control-btn" id="btnExitCinema">Salir Modo Cine</button>
    <button class="control-btn" id="btnTogglePlay">Pausa</button>
    <button class="control-btn" id="btnFullscreen">Modo Cine</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/dashjs@latest/dist/dash.all.min.js"></script>
  <script>
    class TVConsole {
      constructor() {
        this.initializeElements();
        this.initializeState();
        this.setupEventListeners();
        this.loadInitialData();
        this.setupHistoryState();
        this.initializeSubmenus();
      }

      initializeElements() {
        // Elementos principales
        this.videoPlayer = document.getElementById('videoPlayer');
        this.channelsGrid = document.getElementById('channelsGrid');
        this.sidebar = document.querySelector('.sidebar');
        
        // Elementos de UI
        this.currentCategory = document.getElementById('currentCategory');
        this.channelCount = document.getElementById('channelCount');
        this.notification = document.getElementById('notification');
        this.cinemaControls = document.getElementById('cinemaControls');
        this.fullscreenTimer = document.getElementById('fullscreenTimer');
        this.timerCountdown = document.getElementById('timerCountdown');
        this.searchBox = document.getElementById('searchBox');
        
        // Elementos navegables
        this.navItems = [...document.querySelectorAll('.nav-item')];
        this.channelCards = [];
        
        // Elementos de submen√∫s
        this.submenu = document.getElementById('submenu');
        this.submenuBack = document.getElementById('submenuBack');
        this.submenuTitle = document.getElementById('submenuTitle');
        this.submenuItems = document.getElementById('submenuItems');
        this.submenuItemsElements = [];
        
        // Botones
        this.btnExitCinema = document.getElementById('btnExitCinema');
        this.btnTogglePlay = document.getElementById('btnTogglePlay');
        this.btnFullscreen = document.getElementById('btnFullscreen');
      }

      initializeState() {
        this.state = {
          navMode: 'sidebar',
          sidebarIndex: 0,
          gridIndex: 0,
          submenuIndex: 0,
          currentPlaylist: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/All%20Channels.html',
          currentHls: null,
          currentDash: null,
          isCinemaMode: false,
          isFullscreenMode: false,
          isSubmenuVisible: false,
          channels: [],
          filteredChannels: [],
          history: JSON.parse(localStorage.getItem('tvHistory')) || [],
          inactivityTimer: null,
          countdownTimer: null,
          countdownValue: 10,
          columns: 4,
          isSearching: false,
          // Estado para navegaci√≥n jer√°rquica
          navigationStack: [],
          preFullscreenState: {
            isCinemaMode: false,
            navMode: 'grid',
            gridIndex: 0,
            sidebarIndex: 0,
            gridScrollTop: 0,
            activeElement: null,
            searchText: '',
            isSearching: false,
            navigationStack: []
          }
        };

        this.updateLayout();
      }

      // Inicializar datos de submen√∫s
      initializeSubmenus() {
        this.submenusData = {
          'deportes': [
            { name: 'United States', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/United%20States.html' },
            { name: 'Canada', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Canada.html' },
            { name: 'Spain', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Spain.html' },
            { name: 'Italy', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Italy.html' },
            { name: 'France', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/France.html' },
            { name: 'Mexico', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Mexico.html' },
            { name: 'Brazil', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Brazil.html' },
            { name: 'Dominican Republic', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Dominican%20Republic.html' },
            { name: 'Peru', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Peru.html' },
            { name: 'Argentina', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Argentina.html' },
            { name: 'Russia', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Russia.html' },
            { name: 'India', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/India.html' },
            { name: 'China', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/China.html' },
            { name: 'Mongolia', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Mongolia.html' },
            { name: 'Australia', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Australia.html' },
            { name: 'Bolivia', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Bolivia.html' },
            { name: 'Colombia', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Colombia.html' },
            { name: 'Costa Rica', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Costa%20Rica.html' },
            { name: 'Cuba', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Cuba.html' },
            { name: 'Ecuador', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Ecuador.html' },
            { name: 'El Salvador', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/El%20Salvador.html' },
            { name: 'Guatemala', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Guatemala.html' },
            { name: 'Haiti', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Haiti.html' },
            { name: 'Honduras', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Honduras.html' },
            { name: 'Nicaragua', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Nicaragua.html' },
            { name: 'Panama', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Panama.html' },
            { name: 'Paraguay', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Paraguay.html' },
            { name: 'Peru', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Peru.html' },
            { name: 'Uruguay', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Uruguay.html' },
            { name: 'Venezuela', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Venezuela.html' },
            { name: 'Luxemburgo', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Luxemburgo.html' },
            { name: 'M√≥naco', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/M%C3%B3naco.html' },
            { name: 'Portugal', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Portugal.html' },
            { name: 'Chile', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Chile.html' },
            { name: 'Austria', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Austria.html' }
          ],
          'noticias': [
            { name: 'Comedy', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/comedy.html' },
            { name: 'Animation', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/animation.html' },
            { name: 'Documentary', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/documentary.html' },
            { name: 'Culture', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/culture.html' },
            { name: 'Classic', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/classic.html' },
            { name: 'Business', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/business.html' },
            { name: 'Cooking', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/cooking.html' },
            { name: 'Auto', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Auto.html' },
            { name: 'Education', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/education.html' },
            { name: 'Entertainment', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/entertainment.html' },
            { name: 'Family', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/family.html' },
            { name: 'General', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/general.html' },
            { name: 'Kids', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Kids.html' },
            { name: 'Legislative', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/legislative.html' },
            { name: 'Lifestyle', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/lifestyle.html' },
            { name: 'Movies', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/movies.html' },
            { name: 'Music', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/music.html' },
            { name: 'Outdoor', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/outdoor.html' },
            { name: 'Public', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/public.html' },
            { name: 'Relax', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/relax.html' },
            { name: 'Religious', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/relax.html' },
            { name: 'Science', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/science.html' },
            { name: 'Series', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Series.html' },
            { name: 'Shop', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/shop.html' },
            { name: 'Sports', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/Deportes.html' },
            { name: 'Travel', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/travel.html' },
            { name: 'Weather', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/weather.html' }
          ],
          'musica': [
            { name: 'HBO', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/HBO.html' },
            { name: 'NBA', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/NBA.html' },
            { name: 'MLB', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/MLB.html' },
            { name: 'NFL', url: 'https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/NFL.html' },
            { name: 'MLB 5', url: 'https://iptv-org.github.io/iptv/categories/music.m3u' }
          ]
        };
      }

      // Configurar el historial del navegador
      setupHistoryState() {
        // Inicializar el historial del navegador
        if (history.state === null) {
          history.replaceState({
            type: 'main',
            navMode: 'sidebar',
            sidebarIndex: 0,
            playlist: this.state.currentPlaylist,
            category: 'Canales Estados Unidos'
          }, 'Consola TV', window.location.href);
        }
        
        // Escuchar cambios en el historial del navegador
        window.addEventListener('popstate', (event) => {
          this.handlePopState(event);
        });
      }

      // Manejar cambios en el historial del navegador
      handlePopState(event) {
        if (event.state) {
          const state = event.state;
          console.log('Popstate detected:', state);
          
          // Restaurar el estado desde el historial
          if (state.type === 'main') {
            this.state.navMode = state.navMode || 'sidebar';
            this.state.sidebarIndex = state.sidebarIndex || 0;
            
            // Si hay una playlist diferente, cargarla
            if (state.playlist && state.playlist !== this.state.currentPlaylist) {
              this.state.currentPlaylist = state.playlist;
              this.loadPlaylist(state.playlist, this.state.sidebarIndex);
            }
            
            this.currentCategory.textContent = state.category || 'Canales Estados Unidos';
            
            // Actualizar la UI
            this.navItems.forEach((item, index) => {
              item.classList.toggle('active', index === this.state.sidebarIndex);
              item.classList.toggle('focused', index === this.state.sidebarIndex);
            });
            
            // Enfocar el elemento actual
            this.focusCurrentElement();
            
            this.showNotification('Navegaci√≥n restaurada', 'info');
          }
        }
      }

      // Actualizar el historial del navegador
      updateHistoryState(stateData, title = 'Consola TV') {
        history.pushState(stateData, title, window.location.href);
      }

      setupEventListeners() {
        // Navegaci√≥n por teclado MEJORADA para TV
        document.addEventListener('keydown', (e) => this.handleKeyNavigation(e));
        
        // Evento keydown para submen√∫s
        this.submenu.addEventListener('keydown', (e) => this.handleSubmenuKeyNavigation(e));
        
        // Eventos de video
        this.videoPlayer.addEventListener('play', () => this.onVideoPlay());
        this.videoPlayer.addEventListener('pause', () => this.onVideoPause());
        this.videoPlayer.addEventListener('error', (e) => this.onVideoError(e));
        this.videoPlayer.addEventListener('click', () => this.resetInactivityTimer());
        
        // Botones de UI
        this.btnExitCinema.addEventListener('click', () => this.exitCinemaMode());
        this.btnTogglePlay.addEventListener('click', () => this.togglePlayPause());
        this.btnFullscreen.addEventListener('click', () => this.toggleFullscreen());
        
        // Bot√≥n de volver en submen√∫
        this.submenuBack.addEventListener('click', () => this.closeSubmenu());
        
        // B√∫squeda
        this.searchBox.addEventListener('input', () => this.searchChannels());
        this.searchBox.addEventListener('focus', () => this.state.isSearching = true);
        this.searchBox.addEventListener('blur', () => this.state.isSearching = false);
        
        // Navegaci√≥n por rat√≥n (backup)
        this.navItems.forEach((item, index) => {
          if (item.dataset.url) {
            item.addEventListener('click', () => this.loadPlaylist(item.dataset.url, index));
          }
          // Manejar clic en elementos con submen√∫
          if (item.classList.contains('has-submenu')) {
            item.addEventListener('click', () => this.openSubmenu(item.dataset.submenu, index));
          }
        });

        // Detecci√≥n de inactividad
        this.setupInactivityDetection();

        // Eventos de actividad del usuario
        document.addEventListener('mousemove', () => this.resetInactivityTimer());
        document.addEventListener('keydown', () => this.resetInactivityTimer());
        document.addEventListener('click', () => this.resetInactivityTimer());

        // Eventos de pantalla completa
        document.addEventListener('fullscreenchange', () => this.handleFullscreenChange());
        document.addEventListener('webkitfullscreenchange', () => this.handleFullscreenChange());
        document.addEventListener('mozfullscreenchange', () => this.handleFullscreenChange());
        document.addEventListener('MSFullscreenChange', () => this.handleFullscreenChange());
      }

      // MEJORADO: Manejo de navegaci√≥n por teclado en submen√∫s
      handleSubmenuKeyNavigation(e) {
        if (!this.state.isSubmenuVisible) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        switch(e.key) {
          case 'ArrowUp': 
            this.navigateSubmenu(-1);
            break;
          case 'ArrowDown': 
            this.navigateSubmenu(1);
            break;
          case 'ArrowLeft':
            this.closeSubmenu();
            break;
          case 'ArrowRight':
            // Si estamos en submen√∫, la flecha derecha puede abrir otro nivel
            // Por ahora, simplemente no hacemos nada
            break;
          case 'Enter': 
            this.selectSubmenuItem();
            break;
          case 'Escape': 
          case 'Backspace':
            this.closeSubmenu();
            break;
          case 'm': 
          case 'M':
            this.closeSubmenu();
            break;
        }
      }

      // MEJORADO: Navegaci√≥n en submen√∫s
      navigateSubmenu(delta) {
        if (this.submenuItemsElements.length === 0) return;
        
        this.submenuItemsElements[this.state.submenuIndex].classList.remove('focused');
        
        let newIndex = this.state.submenuIndex + delta;
        newIndex = Math.max(0, Math.min(this.submenuItemsElements.length - 1, newIndex));
        
        this.state.submenuIndex = newIndex;
        this.submenuItemsElements[newIndex].classList.add('focused');
        
        // Scroll si es necesario
        this.submenuItemsElements[newIndex].scrollIntoView({ 
          behavior: 'smooth', 
          block: 'nearest' 
        });
      }

      // MEJORADO: Seleccionar elemento del submen√∫
      selectSubmenuItem() {
        if (this.submenuItemsElements.length === 0) return;
        
        const item = this.submenuItemsElements[this.state.submenuIndex];
        const url = item.dataset.url;
        
        if (url) {
          this.closeSubmenu();
          this.loadPlaylist(url, this.state.sidebarIndex);
          this.state.navMode = 'grid';
          this.state.gridIndex = 0;
        }
      }

      // MEJORADO: Abrir submen√∫
      openSubmenu(submenuId, navIndex) {
        const submenuData = this.submenusData[submenuId];
        if (!submenuData) return;
        
        // Actualizar estado
        this.state.isSubmenuVisible = true;
        this.state.navMode = 'submenu';
        this.state.submenuIndex = 0;
        this.state.sidebarIndex = navIndex;
        
        // Actualizar UI
        this.submenuTitle.textContent = this.navItems[navIndex].textContent.trim();
        this.renderSubmenuItems(submenuData);
        this.submenu.classList.add('active');
        
        // Enfocar primer elemento del submen√∫
        if (this.submenuItemsElements.length > 0) {
          this.submenuItemsElements[0].classList.add('focused');
        }
        
        this.showNotification(`Submen√∫ ${this.submenuTitle.textContent} abierto`, 'info');
      }

      // MEJORADO: Cerrar submen√∫
      closeSubmenu() {
        this.state.isSubmenuVisible = false;
        this.state.navMode = 'sidebar';
        this.submenu.classList.remove('active');
        
        // Enfocar el elemento del sidebar que abri√≥ el submen√∫
        this.focusCurrentElement();
        
        this.showNotification('Submen√∫ cerrado', 'info');
      }

      // Renderizar elementos del submen√∫
      renderSubmenuItems(items) {
        this.submenuItems.innerHTML = '';
        this.submenuItemsElements = [];
        
        items.forEach((item, index) => {
          const div = document.createElement('div');
          div.className = 'submenu-item';
          div.textContent = item.name;
          div.dataset.url = item.url;
          div.tabIndex = 0;
          
          div.addEventListener('click', () => {
            this.state.submenuIndex = index;
            this.selectSubmenuItem();
          });
          
          this.submenuItems.appendChild(div);
          this.submenuItemsElements.push(div);
        });
      }

      // MEJORADO: Manejo de teclado con navegaci√≥n mejorada
      handleKeyNavigation(e) {
        // Si estamos en submen√∫, dejar que handleSubmenuKeyNavigation maneje la tecla
        if (this.state.isSubmenuVisible) {
          this.handleSubmenuKeyNavigation(e);
          return;
        }
        
        e.preventDefault();
        this.resetInactivityTimer();
        
        // Si estamos en modo b√∫squeda, manejar solo Escape
        if (this.state.isSearching && e.key !== 'Escape' && e.key !== 'Backspace') {
          return;
        }
        
        switch(e.key) {
          case 'ArrowUp': 
            this.navigate(-1, 0); 
            break;
          case 'ArrowDown': 
            this.navigate(1, 0); 
            break;
          case 'ArrowLeft': 
            this.navigate(0, -1); 
            break;
          case 'ArrowRight': 
            this.navigate(0, 1); 
            break;
          case 'Enter': 
            this.selectItem(); 
            break;
          case ' ': 
            this.togglePlayPause(); 
            break;
          case 'f': case 'F': 
            this.toggleFullscreen(); 
            break;
          case 'c': case 'C': 
            this.toggleCinemaMode(); 
            break;
          case 's': case 'S': 
            this.searchBox.focus(); 
            break;
          case 'Escape': 
            this.handleEscapeOrBack(); 
            break;
          case 'Backspace': 
            this.handleEscapeOrBack(); 
            break;
          case '1': case '2': case '3': case '4': case '5': 
          case '6': case '7': case '8': case '9': 
            this.quickSelect(parseInt(e.key)); 
            break;
        }
      }

      // NUEVO: Navegaci√≥n unificada con comportamiento mejorado
      navigate(rowDelta, colDelta) {
        if (this.state.navMode === 'sidebar') {
          this.navigateSidebar(rowDelta, colDelta);
        } else if (this.state.navMode === 'grid') {
          this.navigateGrid(rowDelta, colDelta);
        } else if (this.state.navMode === 'submenu') {
          this.navigateSubmenu(rowDelta);
        }
      }

      // NUEVO: Navegaci√≥n en sidebar con flechas izquierda/derecha mejorada
      navigateSidebar(rowDelta, colDelta) {
        // Si estamos en sidebar y presionamos flecha derecha, ir al grid si hay canales
        if (colDelta > 0 && this.state.filteredChannels.length > 0) {
          this.state.navMode = 'grid';
          this.state.gridIndex = 0;
          this.focusCurrentElement();
          this.showNotification('Navegando a canales', 'info');
          return;
        }
        
        // MEJORADO: Si estamos en sidebar y presionamos flecha izquierda, navegar entre secciones del sidebar
        if (colDelta < 0) {
          // Podemos implementar navegaci√≥n entre diferentes grupos del sidebar si es necesario
          // Por ahora simplemente no hacemos nada o podemos mostrar un mensaje
          this.showNotification('Ya est√°s en el men√∫ de navegaci√≥n', 'info');
          return;
        }
        
        // Navegaci√≥n vertical normal
        this.navItems[this.state.sidebarIndex].classList.remove('focused');
        this.state.sidebarIndex = Math.max(0, Math.min(this.navItems.length - 1, this.state.sidebarIndex + rowDelta));
        this.navItems[this.state.sidebarIndex].classList.add('focused');
        this.navItems[this.state.sidebarIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      // NUEVO: Navegaci√≥n en grid con flechas izquierda/derecha mejorada
      navigateGrid(rowDelta, colDelta) {
        if (this.channelCards.length === 0) return;
        
        // MEJORADO: Si estamos en grid y presionamos flecha izquierda en la primera columna, volver al sidebar
        const currentCol = this.state.gridIndex % this.state.columns;
        if (colDelta < 0 && currentCol === 0) {
          // Guardar estado actual antes de cambiar al sidebar
          this.state.navigationStack.push({
            navMode: this.state.navMode,
            gridIndex: this.state.gridIndex,
            filteredChannels: [...this.state.filteredChannels],
            category: this.currentCategory.textContent
          });
          
          this.state.navMode = 'sidebar';
          // Mantener el mismo √≠ndice del sidebar que estaba activo antes
          this.focusCurrentElement();
          this.showNotification('Navegando al men√∫ principal', 'info');
          return;
        }
        
        // Si estamos en grid y presionamos flecha derecha en la √∫ltima columna, no hacer nada
        if (colDelta > 0 && currentCol === this.state.columns - 1) {
          return;
        }
        
        // Navegaci√≥n normal en grid
        this.channelCards[this.state.gridIndex].classList.remove('focused');
        
        const oldIndex = this.state.gridIndex;
        const newRow = Math.floor(oldIndex / this.state.columns) + rowDelta;
        const newCol = (oldIndex % this.state.columns) + colDelta;
        
        let newIndex = newRow * this.state.columns + newCol;
        newIndex = Math.max(0, Math.min(this.channelCards.length - 1, newIndex));
        
        this.state.gridIndex = newIndex;
        this.channelCards[newIndex].classList.add('focused');
        
        // Solo hacer scroll si es necesario
        const cardRect = this.channelCards[newIndex].getBoundingClientRect();
        const gridRect = this.channelsGrid.getBoundingClientRect();
        
        if (cardRect.bottom > gridRect.bottom || cardRect.top < gridRect.top) {
          this.channelCards[newIndex].scrollIntoView({ 
            behavior: 'smooth', 
            block: 'nearest' 
          });
        }
      }

      // Abrir submen√∫ desde teclado
      openSubmenuFromKeyboard() {
        if (this.state.navMode !== 'sidebar') return;
        
        const currentItem = this.navItems[this.state.sidebarIndex];
        if (currentItem.classList.contains('has-submenu')) {
          this.openSubmenu(currentItem.dataset.submenu, this.state.sidebarIndex);
        }
      }

      // MANEJO UNIFICADO DE ESCAPE Y BOT√ìN ATR√ÅS - MEJORADO
      handleEscapeOrBack() {
        console.log('Escape/Back pressed - Current state:', {
          isSearching: this.state.isSearching,
          isFullscreenMode: this.state.isFullscreenMode,
          isCinemaMode: this.state.isCinemaMode,
          isSubmenuVisible: this.state.isSubmenuVisible,
          navMode: this.state.navMode,
          navigationStack: this.state.navigationStack.length
        });

        // 1. Si estamos en submen√∫, cerrarlo primero
        if (this.state.isSubmenuVisible) {
          this.closeSubmenu();
          return;
        }

        // 2. Si estamos en b√∫squeda, salir de la b√∫squeda
        if (this.state.isSearching) {
          this.searchBox.blur();
          this.state.isSearching = false;
          this.showNotification('B√∫squeda cancelada', 'info');
          return;
        }

        // 3. Priorizar salir de modo cine si estamos en ese modo
        if (this.state.isFullscreenMode) {
          this.exitFullscreenMode();
          return;
        }

        // 4. Si estamos en modo controles video, salir del modo
        if (this.state.isCinemaMode) {
          this.exitCinemaMode();
          return;
        }

        // 5. Navegaci√≥n jer√°rquica - Si hay elementos en el stack, volver atr√°s
        if (this.state.navigationStack.length > 0) {
          this.navigateBack();
          return;
        }

        // 6. MEJORADO: Si estamos en grid de canales, volver al sidebar con flecha izquierda
        if (this.state.navMode === 'grid') {
          this.navigateToSidebar();
          return;
        }

        // 7. MEJORADO: Mensaje m√°s espec√≠fico cuando ya estamos en sidebar
        if (this.state.navMode === 'sidebar') {
          this.showNotification('Usa las flechas para navegar por el men√∫', 'info');
          return;
        }
      }

      // Navegaci√≥n jer√°rquica hacia atr√°s
      navigateBack() {
        const previousState = this.state.navigationStack.pop();
        
        if (previousState) {
          this.state.navMode = previousState.navMode;
          this.state.gridIndex = previousState.gridIndex || 0;
          this.state.sidebarIndex = previousState.sidebarIndex || 0;
          this.state.filteredChannels = previousState.filteredChannels || this.state.channels;
          this.currentCategory.textContent = previousState.category || 'Canales Estados Unidos';
          
          this.renderChannels();
          this.focusCurrentElement();
          
          this.showNotification('Volviendo atr√°s...', 'info');
        }
      }

      // Navegar al sidebar desde el grid
      navigateToSidebar() {
        // Guardar estado actual en el stack
        this.state.navigationStack.push({
          navMode: this.state.navMode,
          gridIndex: this.state.gridIndex,
          filteredChannels: [...this.state.filteredChannels],
          category: this.currentCategory.textContent
        });

        // Volver al sidebar
        this.state.navMode = 'sidebar';
        this.state.sidebarIndex = 0;
        this.focusCurrentElement();
        
        this.showNotification('Volviendo al men√∫ principal', 'info');
      }

      // M√âTODO handleFullscreenChange SIMPLIFICADO
      handleFullscreenChange() {
        const isFullscreen = !!(document.fullscreenElement || 
                                document.webkitFullscreenElement || 
                                document.mozFullScreenElement || 
                                document.msFullscreenElement);
        
        if (!isFullscreen && this.state.isFullscreenMode) {
          // Salida de modo cine detectada
          this.state.isFullscreenMode = false;
          this.videoPlayer.classList.remove('fullscreen-mode');
          
          // Restaurar el estado despu√©s de salir de modo cine
          this.restorePreFullscreenState();
          
          this.resetInactivityTimer();
        } else if (isFullscreen && !this.state.isFullscreenMode) {
          // Entrada en modo cine
          this.state.isFullscreenMode = true;
          this.videoPlayer.classList.add('fullscreen-mode');
        }
      }

      // M√âTODO exitFullscreenMode - MEJORADO (modo cine)
      exitFullscreenMode() {
        // Primero restaurar el estado previo
        this.restorePreFullscreenState();
        
        // Luego salir de modo cine
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
        
        // Actualizar estado inmediatamente
        this.state.isFullscreenMode = false;
        this.videoPlayer.classList.remove('fullscreen-mode');
        
        // Cancelar cualquier temporizador activo
        clearTimeout(this.state.inactivityTimer);
        clearInterval(this.state.countdownTimer);
        this.fullscreenTimer.classList.remove('show');
        
        this.showNotification('Saliste del modo cine', 'info');
      }

      // Guardar estado completo antes de entrar en modo cine
      savePreFullscreenState() {
        this.state.preFullscreenState = {
          isCinemaMode: this.state.isCinemaMode,
          navMode: this.state.navMode,
          gridIndex: this.state.gridIndex,
          sidebarIndex: this.state.sidebarIndex,
          gridScrollTop: this.channelsGrid.scrollTop,
          activeElement: document.activeElement,
          searchText: this.searchBox.value,
          isSearching: this.state.isSearching,
          navigationStack: [...this.state.navigationStack]
        };
      }

      // Restaurar estado completo despu√©s de salir de modo cine
      restorePreFullscreenState() {
        if (!this.state.preFullscreenState) return;
        
        const prevState = this.state.preFullscreenState;
        
        // Restaurar modo controles video
        if (prevState.isCinemaMode && !this.state.isCinemaMode) {
          this.enterCinemaMode();
        } else if (!prevState.isCinemaMode && this.state.isCinemaMode) {
          this.exitCinemaMode();
        }
        
        // Restaurar modo de navegaci√≥n e √≠ndices
        this.state.navMode = prevState.navMode;
        this.state.gridIndex = prevState.gridIndex;
        this.state.sidebarIndex = prevState.sidebarIndex;
        
        // Restaurar stack de navegaci√≥n
        this.state.navigationStack = [...prevState.navigationStack];
        
        // Restaurar posici√≥n de scroll del grid
        if (prevState.gridScrollTop !== undefined) {
          setTimeout(() => {
            this.channelsGrid.scrollTop = prevState.gridScrollTop;
          }, 50);
        }
        
        // Restaurar b√∫squeda
        if (prevState.searchText !== undefined) {
          this.searchBox.value = prevState.searchText;
        }
        this.state.isSearching = prevState.isSearching;
        
        // Asegurar que el canal enfocado se mantenga visible
        setTimeout(() => {
          this.focusCurrentElement();
        }, 100);
      }

      // Enfocar el elemento actual basado en el estado
      focusCurrentElement() {
        if (this.state.navMode === 'sidebar' && this.navItems.length > 0) {
          this.navItems.forEach(item => item.classList.remove('focused'));
          if (this.state.sidebarIndex < this.navItems.length) {
            this.navItems[this.state.sidebarIndex].classList.add('focused');
            this.navItems[this.state.sidebarIndex].scrollIntoView({ 
              behavior: 'smooth', 
              block: 'nearest' 
            });
          }
        } else if (this.state.navMode === 'grid' && this.channelCards.length > 0) {
          this.channelCards.forEach(card => card.classList.remove('focused'));
          if (this.state.gridIndex < this.channelCards.length) {
            this.channelCards[this.state.gridIndex].classList.add('focused');
            this.channelCards[this.state.gridIndex].scrollIntoView({ 
              behavior: 'smooth', 
              block: 'nearest' 
            });
          }
        } else if (this.state.navMode === 'submenu' && this.submenuItemsElements.length > 0) {
          this.submenuItemsElements.forEach(item => item.classList.remove('focused'));
          if (this.state.submenuIndex < this.submenuItemsElements.length) {
            this.submenuItemsElements[this.state.submenuIndex].classList.add('focused');
            this.submenuItemsElements[this.state.submenuIndex].scrollIntoView({ 
              behavior: 'smooth', 
              block: 'nearest' 
            });
          }
        }
        
        // Restaurar foco en el elemento activo si era un input
        if (this.state.preFullscreenState && this.state.preFullscreenState.activeElement) {
          const prevActive = this.state.preFullscreenState.activeElement;
          if (prevActive.tagName === 'INPUT' || prevActive.tagName === 'TEXTAREA') {
            setTimeout(() => {
              prevActive.focus();
            }, 150);
          }
        }
      }

      // MEJORADO: Cambiado a "Modo Cine"
      enterFullscreenMode() {
        // Guardar el estado completo antes de entrar en modo cine
        this.savePreFullscreenState();
        
        if (this.videoPlayer.requestFullscreen) {
          this.videoPlayer.requestFullscreen();
        } else if (this.videoPlayer.webkitRequestFullscreen) {
          this.videoPlayer.webkitRequestFullscreen();
        } else if (this.videoPlayer.msRequestFullscreen) {
          this.videoPlayer.msRequestFullscreen();
        }
        
        this.state.isFullscreenMode = true;
        this.videoPlayer.classList.add('fullscreen-mode');
        this.showNotification('Modo cine activado', 'info');
      }

      selectItem() {
        if (this.state.navMode === 'sidebar') {
          const item = this.navItems[this.state.sidebarIndex];
          if (item.dataset.url) {
            // Guardar estado actual antes de cambiar
            this.state.navigationStack.push({
              navMode: this.state.navMode,
              sidebarIndex: this.state.sidebarIndex,
              filteredChannels: [...this.state.filteredChannels],
              category: this.currentCategory.textContent
            });

            this.loadPlaylist(item.dataset.url, this.state.sidebarIndex);
            this.state.navMode = 'grid';
            this.state.gridIndex = 0;
            
            // Actualizar historial del navegador
            this.updateHistoryState({
              type: 'main',
              navMode: 'grid',
              sidebarIndex: this.state.sidebarIndex,
              playlist: item.dataset.url,
              category: item.textContent.trim()
            }, `Consola TV - ${item.textContent.trim()}`);
          } else if (item.classList.contains('has-submenu')) {
            this.openSubmenu(item.dataset.submenu, this.state.sidebarIndex);
          }
        } else if (this.state.navMode === 'grid') {
          this.playChannel(this.state.gridIndex);
        }
      }

      async loadPlaylist(url, navIndex) {
        this.showNotification('Cargando canales...', 'info');
        this.channelsGrid.innerHTML = '<div class="loading">Cargando canales</div>';
        
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error('Error de red');
          const data = await response.text();
          this.parseM3U(data);
          
          // Actualizar UI
          this.navItems.forEach(item => item.classList.remove('active'));
          this.navItems[navIndex].classList.add('active');
          this.currentCategory.textContent = this.navItems[navIndex].textContent.trim();
          
          this.showNotification(`Canales cargados: ${this.state.channels.length}`, 'success');
        } catch (error) {
          this.showNotification('Error al cargar canales', 'error');
          this.channelsGrid.innerHTML = '<div class="error">Error al cargar los canales</div>';
        }
      }

      parseM3U(data) {
        const lines = data.split("\n");
        let currentChannel = {};
        const channels = [];
        lines.forEach(line => {
          if (line.startsWith("#EXTINF")) {
            const nameMatch = line.match(/,(.*)$/);
            const logoMatch = line.match(/tvg-logo="(.*?)"/);
            currentChannel = {
              name: nameMatch ? nameMatch[1].trim() : "Canal sin nombre",
              logo: logoMatch ? logoMatch[1] : "https://via.placeholder.com/150x80?text=No+Logo"
            };
          } else if (line.startsWith("http")) {
            currentChannel.url = line.trim();
            channels.push({...currentChannel});
            currentChannel = {};
          }
        });
        this.state.channels = channels;
        this.state.filteredChannels = [...channels];
        this.renderChannels();
      }

      // MEJORADO: Renderizado sin numeraci√≥n
      renderChannels() {
        this.channelsGrid.innerHTML = "";
        this.channelCards = [];
        
        if (this.state.filteredChannels.length === 0) {
          this.channelsGrid.innerHTML = '<div class="error">No se encontraron canales</div>';
          return;
        }
        
        this.state.filteredChannels.forEach((channel, index) => {
          const div = document.createElement("div");
          div.className = "channel-card";
          div.tabIndex = 0;
          div.dataset.url = channel.url;
          
          // Verificar si es reciente
          const isRecent = this.state.history.some(hist => hist.url === channel.url);
          
          if (isRecent) div.classList.add('recent');
          
          // MEJORADO: Sin numeraci√≥n
          div.innerHTML = `
            <img class="channel-logo" src="${channel.logo}" alt="${channel.name}" 
                 onerror="this.src='https://via.placeholder.com/150x80?text=No+Logo'">
            <div class="channel-name">${channel.name}</div>
          `;

          div.addEventListener("click", () => this.playChannel(index));

          this.channelsGrid.appendChild(div);
          this.channelCards.push(div);
        });
        
        this.channelCount.textContent = `${this.state.filteredChannels.length} canales`;
        this.updateLayout();
        
        // Enfocar primer canal
        if (this.channelCards.length > 0) {
          this.channelCards[0].classList.add('focused');
        }
      }

      // NUEVO: Reproductor MPD (MPEG-DASH)
      playMPD(url) {
        if (this.state.currentDash) {
          this.state.currentDash.destroy();
        }
        
        this.state.currentDash = dashjs.MediaPlayer().create();
        this.state.currentDash.initialize(this.videoPlayer, url, true);
        
        this.videoPlayer.play().catch(e => {
          console.error('Error play MPD:', e);
          this.showNotification('Error al reproducir el canal', 'error');
        });
      }

      // NUEVO: Reproductor M3U8 nativo
      playM3U8(url) {
        if (Hls.isSupported()) {
          if (this.state.currentHls) {
            this.state.currentHls.destroy();
          }
          
          this.state.currentHls = new Hls({
            enableWorker: false,
            lowLatencyMode: true
          });
          this.state.currentHls.loadSource(url);
          this.state.currentHls.attachMedia(this.videoPlayer);
          this.state.currentHls.on(Hls.Events.MANIFEST_PARSED, () => {
            this.videoPlayer.play().catch(e => {
              console.error('Error play M3U8:', e);
              this.showNotification('Error al reproducir el canal', 'error');
            });
          });
          this.state.currentHls.on(Hls.Events.ERROR, (event, data) => {
            console.error('HLS Error:', data);
            if (data.fatal) {
              this.showNotification('Error de transmisi√≥n del canal', 'error');
            }
          });
        } else if (this.videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
          // Soporte nativo para Safari
          this.videoPlayer.src = url;
          this.videoPlayer.play().catch(e => {
            console.error('Error play M3U8:', e);
            this.showNotification('Error al reproducir el canal', 'error');
          });
        } else {
          this.showNotification('Formato no compatible en este navegador', 'error');
        }
      }

      // NUEVO: Reproductor M3U
      playM3U(url) {
        this.videoPlayer.src = url;
        this.videoPlayer.play().catch(e => {
          console.error('Error play M3U:', e);
          this.showNotification('Error al reproducir el canal', 'error');
        });
      }

      // NUEVO: Soporte EPG (Electronic Program Guide)
      loadEPG(epgUrl) {
        fetch(epgUrl)
          .then(response => response.text())
          .then(data => {
            this.parseEPG(data);
            this.showNotification('Gu√≠a de programaci√≥n cargada', 'success');
          })
          .catch(error => {
            console.error('Error loading EPG:', error);
            this.showNotification('Error al cargar la gu√≠a de programaci√≥n', 'error');
          });
      }

      // NUEVO: Parsear datos EPG (formato XMLTV simplificado)
      parseEPG(data) {
        // Esta es una implementaci√≥n b√°sica para parsear EPG
        // En una implementaci√≥n real, necesitar√≠as un parser XML m√°s robusto
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(data, "text/xml");
        
        // Extraer informaci√≥n de programas
        const programmes = xmlDoc.getElementsByTagName("programme");
        const epgData = [];
        
        for (let i = 0; i < programmes.length; i++) {
          const programme = programmes[i];
          const channel = programme.getAttribute("channel");
          const start = programme.getAttribute("start");
          const stop = programme.getAttribute("stop");
          const title = programme.getElementsByTagName("title")[0]?.textContent || "Sin t√≠tulo";
          const desc = programme.getElementsByTagName("desc")[0]?.textContent || "";
          
          epgData.push({
            channel,
            start,
            stop,
            title,
            desc
          });
        }
        
        // Guardar datos EPG para uso posterior
        this.state.epgData = epgData;
        
        // Actualizar UI con informaci√≥n EPG si est√° disponible
        this.updateEPGDisplay();
      }

      // NUEVO: Actualizar visualizaci√≥n EPG
      updateEPGDisplay() {
        // Aqu√≠ puedes implementar la l√≥gica para mostrar la informaci√≥n EPG
        // en la interfaz de usuario, por ejemplo, en tooltips o en un panel separado
        console.log('EPG data loaded:', this.state.epgData);
      }

      playChannel(index) {
        const channel = this.state.filteredChannels[index];
        if (!channel) return;
        
        this.showNotification(`Cargando: ${channel.name}`, 'info');
        
        // Limpiar reproducci√≥n anterior
        if (this.state.currentHls) {
          this.state.currentHls.destroy();
        }
        if (this.state.currentDash) {
          this.state.currentDash.destroy();
        }
        
        // Actualizar UI
        this.channelCards.forEach(card => card.classList.remove('playing'));
        this.channelCards[index].classList.add('playing');
        this.channelCards[index].classList.add('focused');
        this.state.gridIndex = index;
        
        // A√±adir al historial
        this.addToHistory(channel);
        
        // Configurar video
        this.videoPlayer.classList.add('active');
        
        // NUEVO: Seleccionar reproductor seg√∫n el tipo de archivo
        const url = channel.url.toLowerCase();
        
        if (url.includes('.mpd')) {
          // Reproductor MPD para MPEG-DASH
          this.playMPD(channel.url);
        } else if (url.includes('.m3u8')) {
          // Reproductor M3U8 para HLS
          this.playM3U8(channel.url);
        } else if (url.includes('.m3u')) {
          // Reproductor M3U para listas de reproducci√≥n
          this.playM3U(channel.url);
        } else {
          // Reproductor por defecto (para otros formatos)
          this.videoPlayer.src = channel.url;
          this.videoPlayer.play().catch(e => {
            console.error('Error play:', e);
            this.showNotification('Error al reproducir el canal', 'error');
          });
        }

        // Iniciar temporizador para modo cine
        this.resetInactivityTimer();
      }

      // Sistema de modo cine autom√°tico - MEJORADO (20 segundos)
      resetInactivityTimer() {
        clearTimeout(this.state.inactivityTimer);
        clearInterval(this.state.countdownTimer);
        
        this.fullscreenTimer.classList.remove('show');
        
        if (!this.videoPlayer.paused && this.videoPlayer.src && !this.state.isFullscreenMode) {
          this.state.inactivityTimer = setTimeout(() => {
            this.startFullscreenCountdown();
          }, 3000); // 3 segundos de inactividad antes de mostrar countdown
        }
      }

      // MEJORADO: Cambiado a "Modo Cine" y extendido a 20 segundos
      startFullscreenCountdown() {
        this.state.countdownValue = 20; // CAMBIADO: De 5 a 20 segundos
        this.timerCountdown.textContent = this.state.countdownValue;
        this.fullscreenTimer.classList.add('show');
        
        this.state.countdownTimer = setInterval(() => {
          this.state.countdownValue--;
          this.timerCountdown.textContent = this.state.countdownValue;
          
          if (this.state.countdownValue <= 0) {
            clearInterval(this.state.countdownTimer);
            this.fullscreenTimer.classList.remove('show');
            this.enterFullscreenMode();
          }
        }, 1000);
      }

      // Control de reproducci√≥n
      togglePlayPause() {
        if (this.videoPlayer.paused) {
          this.videoPlayer.play();
        } else {
          this.videoPlayer.pause();
        }
      }

      // MEJORADO: Cambiado a "Modo Cine"
      toggleFullscreen() {
        if (!this.state.isFullscreenMode) {
          this.enterFullscreenMode();
        } else {
          this.exitFullscreenMode();
        }
      }

      toggleCinemaMode() {
        if (this.state.isCinemaMode) {
          this.exitCinemaMode();
        } else {
          this.enterCinemaMode();
        }
      }

      enterCinemaMode() {
        this.state.isCinemaMode = true;
        document.body.classList.add('cinema-mode');
        this.cinemaControls.style.display = 'flex';
        this.showNotification('Controles de video activados', 'info');
      }

      exitCinemaMode() {
        this.state.isCinemaMode = false;
        document.body.classList.remove('cinema-mode');
        this.cinemaControls.style.display = 'none';
      }

      quickSelect(number) {
        if (number <= this.channelCards.length) {
          this.playChannel(number - 1);
        }
      }

      // Sistema de b√∫squeda
      searchChannels() {
        const query = this.searchBox.value.toLowerCase();
        
        if (query === '') {
          this.state.filteredChannels = [...this.state.channels];
        } else {
          this.state.filteredChannels = this.state.channels.filter(channel => 
            channel.name.toLowerCase().includes(query)
          );
        }
        
        this.renderChannels();
      }

      // Historial de visualizaci√≥n
      addToHistory(channel) {
        const index = this.state.history.findIndex(hist => hist.url === channel.url);
        if (index !== -1) {
          this.state.history.splice(index, 1);
        }
        
        this.state.history.unshift(channel);
        
        if (this.state.history.length > 20) {
          this.state.history.pop();
        }
        
        localStorage.setItem('tvHistory', JSON.stringify(this.state.history));
      }

      // Utilidades
      showNotification(message, type = 'info') {
        this.notification.textContent = message;
        this.notification.className = `tv-notification ${type} show`;
        
        setTimeout(() => {
          this.notification.classList.remove('show');
        }, 3000);
      }

      updateLayout() {
        const gridWidth = this.channelsGrid.clientWidth;
        const cardWidth = 180;
        this.state.columns = Math.max(1, Math.floor(gridWidth / cardWidth));
      }

      // MEJORADO: Reloj eliminado
      setupInactivityDetection() {
        this.resetInactivityTimer();
      }

      loadInitialData() {
        this.loadPlaylist(this.state.currentPlaylist, 0);
      }

      onVideoPlay() {
        this.btnTogglePlay.textContent = 'Pausa';
        this.resetInactivityTimer();
      }

      onVideoPause() {
        this.btnTogglePlay.textContent = 'Play';
        clearTimeout(this.state.inactivityTimer);
        clearInterval(this.state.countdownTimer);
        this.fullscreenTimer.classList.remove('show');
      }

      onVideoError(e) {
        this.showNotification('Error al reproducir el canal', 'error');
        console.error('Video error:', e);
      }
    }

    // Inicializar la consola TV cuando se carga la p√°gina
    document.addEventListener('DOMContentLoaded', () => {
      window.tvConsole = new TVConsole();
    });

    // Manejar cambios de tama√±o para responsive
    window.addEventListener('resize', () => {
      if (window.tvConsole) {
        window.tvConsole.updateLayout();
      }
    });
  </script>
</body>
</html>


