<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIVE TV</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://raw.githubusercontent.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js" as="script">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#000;color:#fff;height:100vh;overflow:hidden;display:flex}
        
        /* ‚ïê‚ïê‚ïê FULLSCREEN: OCULTAR TODO ‚ïê‚ïê‚ïê */
        body.fullscreen-active{cursor:none}
        body.fullscreen-active .sidebar,
        body.fullscreen-active .video-overlay,
        body.fullscreen-active .quick-controls,
        body.fullscreen-active .error-toast,
        body.fullscreen-active .toggle-sidebar,
        body.fullscreen-active .empty-state{
            display:none!important;
            opacity:0!important;
            visibility:hidden!important;
            pointer-events:none!important
        }
        body.fullscreen-active .player-area{
            position:fixed;
            top:0;left:0;right:0;bottom:0;
            z-index:9999
        }
        body.fullscreen-active video{
            width:100vw!important;
            height:100vh!important;
            object-fit:contain!important
        }
        /* ‚ïê‚ïê‚ïê FIN FULLSCREEN ‚ïê‚ïê‚ïê */

        ::-webkit-scrollbar{width:3px;height:3px}
        ::-webkit-scrollbar-track{background:transparent}
        ::-webkit-scrollbar-thumb{background:#444}

        .sidebar{width:320px;background:rgba(20,20,20,0.95);display:flex;flex-direction:column;z-index:10;position:relative}
        .sidebar.hidden{transform:translateX(-100%);position:absolute;height:100vh}

        .search-container{padding:12px 16px;background:rgba(30,30,30,0.95);border-bottom:1px solid rgba(255,255,255,0.05);flex-shrink:0}
        .search-input{width:100%;padding:12px 16px;background:rgba(255,255,255,0.08);border:2px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:15px;outline:none}
        .search-input::placeholder{color:#666}
        .search-input:focus,.search-input.nav-focused{background:rgba(255,255,255,0.12);border-color:#667eea}

        .category-dropdown{padding:12px 16px;background:rgba(25,25,25,0.95);border-bottom:1px solid rgba(255,255,255,0.05);position:relative;z-index:5}
        .category-select-wrapper{position:relative}
        .category-select{width:100%;padding:12px 40px 12px 16px;background:rgba(255,255,255,0.08);border:2px solid rgba(255,255,255,0.15);border-radius:10px;color:white;font-size:14px;font-weight:500;outline:none;appearance:none;-webkit-appearance:none;-moz-appearance:none;cursor:pointer}
        .category-select:hover{background:rgba(255,255,255,0.12);border-color:rgba(255,255,255,0.25)}
        .category-select:focus{background:rgba(255,255,255,0.15);border-color:#667eea;box-shadow:0 0 0 2px rgba(102,126,234,0.2)}
        .category-select option{background:rgba(30,30,30,0.98);color:white;padding:10px}
        .select-arrow{position:absolute;right:16px;top:50%;width:12px;height:12px;border-right:2px solid rgba(255,255,255,0.5);border-bottom:2px solid rgba(255,255,255,0.5);transform:translateY(-50%) rotate(45deg);pointer-events:none}
        .category-select:focus+.select-arrow{transform:translateY(-50%) rotate(225deg);border-color:#667eea}

        .channel-list{flex:1;overflow-y:auto;padding:8px}
        .channel-group{margin-bottom:20px}
        .group-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:#888;padding:8px 12px;position:sticky;top:0;background:rgba(20,20,20,0.98);z-index:1}

        .channel-item{display:flex;align-items:center;padding:12px;margin:2px 0;background:rgba(255,255,255,0.03);border-radius:8px;cursor:pointer;border:2px solid transparent;gap:12px}
        .channel-item:hover{background:rgba(255,255,255,0.08)}
        .channel-item.active{background:rgba(102,126,234,0.15);border-color:rgba(102,126,234,0.3)}
        .channel-item.focused{border-color:#667eea;background:rgba(102,126,234,0.2)}

        .channel-logo{min-width:48px;height:48px;background:rgba(255,255,255,0.08);border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden}
        .channel-logo img{width:100%;height:100%;object-fit:contain;padding:4px}
        .channel-logo-fallback{width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;font-size:16px;font-weight:600}
        .channel-item.active .channel-logo{box-shadow:0 0 0 2px #667eea}

        .channel-info{flex:1;min-width:0}
        .channel-name{font-size:14px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
        .channel-meta{font-size:11px;color:#666;display:flex;align-items:center;gap:8px}
        .live-dot{width:6px;height:6px;background:#f44336;border-radius:50%}

        .player-area{flex:1;position:relative;background:#000;display:flex;flex-direction:column}
        .player-area.fullscreen{position:fixed;top:0;left:0;right:0;bottom:0;z-index:5}
        .video-container{flex:1;position:relative;display:flex;align-items:center;justify-content:center}

        video{width:100%;height:100%;object-fit:contain;outline:none}
        video::-webkit-media-controls,video::-webkit-media-controls-panel,video::-webkit-media-controls-enclosure{display:none!important}
        video::-moz-media-controls{display:none!important}

        .video-overlay{position:absolute;top:0;left:0;right:0;padding:20px;background:linear-gradient(to bottom,rgba(0,0,0,0.7) 0%,transparent 100%);display:flex;justify-content:space-between;align-items:flex-start;opacity:0;pointer-events:none}
        .player-area:hover .video-overlay,.video-overlay.visible{opacity:1}

        .now-playing{display:flex;align-items:center;gap:12px}
        .now-playing-logo{width:40px;height:40px;background:rgba(255,255,255,0.1);border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden}
        .now-playing-logo img{width:100%;height:100%;object-fit:contain;padding:4px}
        .now-playing-info{display:flex;flex-direction:column;gap:4px}
        .now-playing-channel{font-size:18px;font-weight:600}
        .now-playing-category{font-size:12px;color:#aaa}

        .toggle-sidebar{position:absolute;left:0;top:50%;transform:translateY(-50%);width:1px;height:1px;background:transparent;border:none;cursor:pointer;z-index:15;opacity:0}

        .spinner{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:40px;height:40px;border:3px solid rgba(255,255,255,0.1);border-top-color:#667eea;border-radius:50%;animation:spin 1s linear infinite;display:none}
        .spinner.active{display:block}
        @keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}

        .empty-state{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;opacity:0.5}
        .empty-state svg{width:64px;height:64px;margin-bottom:16px;opacity:0.3}
        .empty-state-text{font-size:14px;color:#666}

        .error-toast{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:#f44336;color:white;padding:12px 24px;border-radius:8px;font-size:14px;display:none;z-index:20}
        .error-toast.show{display:block}

        .quick-controls{position:absolute;bottom:20px;right:20px;display:flex;gap:8px;opacity:0;z-index:15}
        .player-area:hover .quick-controls{opacity:1}
        .control-btn{width:36px;height:36px;background:rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.2);border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer}
        .control-btn:hover{background:rgba(102,126,234,0.8)}
        .control-btn svg{width:18px;height:18px;fill:white}

        .loading-status{text-align:center;padding:40px 20px;color:#888}
        .loading-status .spinner-inline{width:30px;height:30px;border:3px solid rgba(255,255,255,0.1);border-top-color:#667eea;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px}
        .no-results{text-align:center;padding:40px 20px;color:#666;font-size:14px}

        @media(max-width:768px){.sidebar{width:100%;position:absolute;height:100%}.category-select{font-size:13px;padding:10px 36px 10px 14px}.select-arrow{right:14px;width:10px;height:10px}}
    </style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <div class="search-container">
        <input type="text" class="search-input" id="searchInput" placeholder="Buscar canal..." autocomplete="off" spellcheck="false">
    </div>
    <div class="category-dropdown">
        <div class="category-select-wrapper">
            <select class="category-select" id="categorySelect"></select>
            <div class="select-arrow"></div>
        </div>
    </div>
    <div class="channel-list" id="channelList">
        <div class="loading-status" id="loadingStatus">
            <div class="spinner-inline"></div>
            <div>Cargando canales...</div>
        </div>
    </div>
</div>

<div class="player-area" id="playerArea">
    <div class="video-container">
        <video id="videoPlayer" playsinline></video>
        <div class="empty-state" id="emptyState">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><rect x="2" y="7" width="20" height="15" rx="2"></rect><polyline points="17 2 12 7 7 2"></polyline></svg>
            <div class="empty-state-text">Selecciona un canal para comenzar</div>
        </div>
        <div class="spinner" id="spinner"></div>
    </div>
    <div class="video-overlay" id="overlay">
        <div class="now-playing">
            <div class="now-playing-logo" id="nowPlayingLogo"></div>
            <div class="now-playing-info">
                <div class="now-playing-channel" id="nowPlayingChannel">-</div>
                <div class="now-playing-category" id="nowPlayingCategory">-</div>
            </div>
        </div>
    </div>
    <button class="toggle-sidebar" id="toggleSidebar"></button>
    <div class="quick-controls" id="quickControls">
        <button class="control-btn" id="btnUp"><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></button>
        <button class="control-btn" id="btnDown"><svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"></path></svg></button>
        <button class="control-btn" id="btnFs"><svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"></path></svg></button>
    </div>
    <div class="error-toast" id="errorToast"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>
<script>
var PLAYLIST_URL = "https://raw.githubusercontent.com/Miguel179-spe/tvlion/refs/heads/peliculas/LiveTV.m3u";
var channels = [];
var filteredChannels = [];
var categories = ['all'];
var currentCategory = 'all';
var currentChannel = null;
var hlsInstance = null;
var currentIndex = -1;
var focusedIndex = -1;
var sidebarVisible = true;
var isInFullscreen = false;
var searchTimeout = null;
var playlistCache = null;

var video = document.getElementById('videoPlayer');
var searchInput = document.getElementById('searchInput');
var categorySelect = document.getElementById('categorySelect');
var channelList = document.getElementById('channelList');
var spinner = document.getElementById('spinner');
var emptyState = document.getElementById('emptyState');
var overlay = document.getElementById('overlay');
var errorToast = document.getElementById('errorToast');
var sidebar = document.getElementById('sidebar');
var playerArea = document.getElementById('playerArea');

function getInitials(name) {
    var words = name.split(' ');
    if (words.length === 1) return words[0].substring(0, 2).toUpperCase();
    return (words[0][0] + words[1][0]).toUpperCase();
}

function toggleSidebar() {
    sidebarVisible = !sidebarVisible;
    if (sidebarVisible) {
        sidebar.classList.remove('hidden');
        playerArea.classList.remove('fullscreen');
    } else {
        sidebar.classList.add('hidden');
        playerArea.classList.add('fullscreen');
        video.focus();
        searchInput.blur();
    }
}

function showSpinner(show) {
    spinner.classList.toggle('active', show);
}

function showError(message) {
    if (!isInFullscreen) {
        errorToast.textContent = message;
        errorToast.classList.add('show');
        setTimeout(function() { errorToast.classList.remove('show'); }, 4000);
    }
}

function hideEmptyState() {
    emptyState.style.display = 'none';
}

function showOverlay() {
    if (!isInFullscreen) {
        overlay.classList.add('visible');
        setTimeout(function() { overlay.classList.remove('visible'); }, 1500);
    }
}

function getVisibleChannels() {
    if (searchInput.value) {
        return filteredChannels;
    } else if (currentCategory === 'all') {
        return channels;
    } else {
        var result = [];
        for (var i = 0; i < channels.length; i++) {
            if (channels[i].group === currentCategory) result.push(channels[i]);
        }
        return result;
    }
}

function channelUp() {
    var list = getVisibleChannels();
    if (list.length === 0) return;
    var idx = -1;
    for (var i = 0; i < list.length; i++) {
        if (list[i].id === currentIndex) { idx = i; break; }
    }
    idx = (idx <= 0) ? list.length - 1 : idx - 1;
    playChannel(list[idx]);
}

function channelDown() {
    var list = getVisibleChannels();
    if (list.length === 0) return;
    var idx = -1;
    for (var i = 0; i < list.length; i++) {
        if (list[i].id === currentIndex) { idx = i; break; }
    }
    idx = (idx === -1 || idx >= list.length - 1) ? 0 : idx + 1;
    playChannel(list[idx]);
}

function loadPlaylist() {
    if (playlistCache) {
        parseM3U(playlistCache);
        if (channels.length > 0) {
            renderCategories();
            renderChannels(channels);
        }
        return;
    }
    
    var xhr = new XMLHttpRequest();
    xhr.open('GET', PLAYLIST_URL, true);
    xhr.timeout = 10000;
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (xhr.status === 200 && xhr.responseText.indexOf('#EXTINF') !== -1) {
                playlistCache = xhr.responseText;
                parseM3U(xhr.responseText);
                if (channels.length > 0) {
                    renderCategories();
                    renderChannels(channels);
                }
            } else {
                channelList.innerHTML = '<div class="no-results"><div style="color:#f44336;">Error al cargar canales</div><button onclick="loadPlaylist()" style="margin-top:15px;padding:10px 20px;background:#667eea;border:none;border-radius:8px;color:white;cursor:pointer;">Reintentar</button></div>';
            }
        }
    };
    xhr.ontimeout = function() {
        channelList.innerHTML = '<div class="no-results"><div style="color:#f44336;">Tiempo agotado</div><button onclick="loadPlaylist()" style="margin-top:15px;padding:10px 20px;background:#667eea;border:none;border-radius:8px;color:white;cursor:pointer;">Reintentar</button></div>';
    };
    xhr.send();
}

function parseM3U(text) {
    var lines = text.split('\n');
    var group = 'General', name = '', logo = '';
    channels = [];
    categories = ['all'];
    
    for (var i = 0, len = lines.length; i < len; i++) {
        var l = lines[i].trim();
        if (l.indexOf('#EXTINF:') === 0) {
            var g = l.match(/group-title="([^"]+)"/i);
            var n = l.match(/,(.+)$/);
            var lo = l.match(/tvg-logo="([^"]+)"/i);
            if (g) group = g[1];
            if (n) name = n[1].trim();
            if (lo) logo = lo[1];
        } else if (l.indexOf('http') === 0) {
            channels.push({
                name: name || ('Canal ' + (channels.length + 1)),
                group: group || 'Sin categor√≠a',
                url: l,
                logo: logo,
                id: channels.length
            });
            if (group && categories.indexOf(group) === -1) {
                categories.push(group);
            }
            name = '';
            logo = '';
            group = 'General';
        }
    }
    
    channels.sort(function(a, b) {
        var c = a.group.localeCompare(b.group);
        return c !== 0 ? c : a.name.localeCompare(b.name);
    });
}

function getCategoryIcon(cat) {
    var c = cat.toLowerCase();
    if (c.indexOf('pelicula') !== -1 || c.indexOf('cine') !== -1) return 'üé¨';
    if (c.indexOf('deporte') !== -1) return '‚öΩ';
    if (c.indexOf('infantil') !== -1 || c.indexOf('ni√±os') !== -1) return 'üßí';
    if (c.indexOf('m√∫sica') !== -1 || c.indexOf('music') !== -1) return 'üéµ';
    if (c.indexOf('noticia') !== -1) return 'üì∞';
    if (c.indexOf('docu') !== -1) return 'üé•';
    return 'üì∫';
}

function renderCategories() {
    var html = '<option value="all">üé¨ Todos los canales (' + channels.length + ')</option>';
    var sorted = categories.slice(1).sort(function(a, b) { return a.localeCompare(b); });
    
    for (var i = 0; i < sorted.length; i++) {
        var cat = sorted[i];
        var count = 0;
        for (var j = 0; j < channels.length; j++) {
            if (channels[j].group === cat) count++;
        }
        if (count > 0) {
            html += '<option value="' + cat + '">' + getCategoryIcon(cat) + ' ' + cat + ' (' + count + ')</option>';
        }
    }
    
    categorySelect.innerHTML = html;
    categorySelect.value = 'all';
}

function filterByCategory(category) {
    currentCategory = category;
    categorySelect.value = category;
    
    var query = searchInput.value.toLowerCase().trim();
    
    if (query) {
        filteredChannels = [];
        for (var i = 0; i < channels.length; i++) {
            var ch = channels[i];
            var matchCat = category === 'all' || ch.group === category;
            var matchQuery = ch.name.toLowerCase().indexOf(query) !== -1 || ch.group.toLowerCase().indexOf(query) !== -1;
            if (matchCat && matchQuery) filteredChannels.push(ch);
        }
        renderChannels(filteredChannels);
    } else {
        if (category === 'all') {
            renderChannels(channels);
        } else {
            var filtered = [];
            for (var i = 0; i < channels.length; i++) {
                if (channels[i].group === category) filtered.push(channels[i]);
            }
            renderChannels(filtered);
        }
    }
    
    focusedIndex = -1;
    var items = document.querySelectorAll('.channel-item');
    for (var i = 0; i < items.length; i++) {
        items[i].classList.remove('focused');
    }
}

function renderChannels(list) {
    if (list.length === 0) {
        channelList.innerHTML = '<div class="no-results">No se encontraron canales</div>';
        return;
    }
    
    var html = '';
    
    if (currentCategory === 'all' && !searchInput.value) {
        var groups = {};
        for (var i = 0; i < list.length; i++) {
            var ch = list[i];
            if (!groups[ch.group]) groups[ch.group] = [];
            groups[ch.group].push(ch);
        }
        
        var groupNames = Object.keys(groups).sort();
        for (var g = 0; g < groupNames.length; g++) {
            var groupName = groupNames[g];
            var groupChannels = groups[groupName];
            html += '<div class="channel-group"><div class="group-title">' + groupName + ' (' + groupChannels.length + ')</div>';
            for (var c = 0; c < groupChannels.length; c++) {
                html += createChannelHTML(groupChannels[c]);
            }
            html += '</div>';
        }
    } else {
        for (var i = 0; i < list.length; i++) {
            html += createChannelHTML(list[i]);
        }
    }
    
    channelList.innerHTML = html;
    bindChannelEvents();
}

function createChannelHTML(channel) {
    var isActive = currentChannel && channel.id === currentChannel.id;
    var activeClass = isActive ? ' active' : '';
    
    var logoHTML;
    if (channel.logo) {
        logoHTML = '<img src="' + channel.logo + '" loading="lazy" onerror="this.outerHTML=\'<div class=channel-logo-fallback>' + getInitials(channel.name) + '</div>\'">';
    } else {
        logoHTML = '<div class="channel-logo-fallback">' + getInitials(channel.name) + '</div>';
    }
    
    return '<div class="channel-item' + activeClass + '" data-id="' + channel.id + '">' +
        '<div class="channel-logo">' + logoHTML + '</div>' +
        '<div class="channel-info">' +
            '<div class="channel-name">' + channel.name + '</div>' +
            '<div class="channel-meta"><span class="live-dot"></span><span>EN VIVO</span><span style="margin-left:auto;font-size:10px;">' + channel.group + '</span></div>' +
        '</div></div>';
}

function bindChannelEvents() {
    var items = document.querySelectorAll('.channel-item');
    for (var i = 0; i < items.length; i++) {
        (function(item) {
            item.onclick = function() {
                var id = parseInt(item.dataset.id);
                for (var j = 0; j < channels.length; j++) {
                    if (channels[j].id === id) {
                        playChannel(channels[j]);
                        break;
                    }
                }
            };
        })(items[i]);
    }
}

function playChannel(channel) {
    if (!channel) return;
    
    currentChannel = channel;
    currentIndex = channel.id;
    
    hideEmptyState();
    showSpinner(true);
    showOverlay();
    
    var items = document.querySelectorAll('.channel-item');
    for (var i = 0; i < items.length; i++) {
        var id = parseInt(items[i].dataset.id);
        if (id === channel.id) {
            items[i].classList.add('active');
            items[i].classList.remove('focused');
            items[i].scrollIntoView({ block: 'center', behavior: 'auto' });
        } else {
            items[i].classList.remove('active');
            items[i].classList.remove('focused');
        }
    }
    
    document.getElementById('nowPlayingChannel').textContent = channel.name;
    document.getElementById('nowPlayingCategory').textContent = channel.group;
    
    var logoContainer = document.getElementById('nowPlayingLogo');
    if (channel.logo) {
        logoContainer.innerHTML = '<img src="' + channel.logo + '" onerror="this.outerHTML=\'' + getInitials(channel.name) + '\'">';
    } else {
        logoContainer.innerHTML = '<div class="channel-logo-fallback">' + getInitials(channel.name) + '</div>';
    }
    
    if (hlsInstance) {
        hlsInstance.destroy();
        hlsInstance = null;
    }
    
    video.pause();
    video.removeAttribute('src');
    video.load();
    
    if (channel.url.indexOf('.m3u8') !== -1) {
        playHLS(channel.url);
    } else {
        playDirect(channel.url);
    }
}

function playHLS(url) {
    if (!Hls.isSupported()) {
        if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = url;
            video.addEventListener('loadedmetadata', function onMeta() {
                showSpinner(false);
                video.play();
                video.removeEventListener('loadedmetadata', onMeta);
            });
        }
        return;
    }
    
    hlsInstance = new Hls({
        enableWorker: true,
        lowLatencyMode: false,
        backBufferLength: 30,
        maxBufferLength: 20,
        maxMaxBufferLength: 40,
        maxBufferSize: 20 * 1000 * 1000,
        maxBufferHole: 0.3,
        startLevel: -1,
        abrEwmaDefaultEstimate: 500000,
        abrBandWidthUpFactor: 0.7,
        abrBandWidthFactor: 0.9,
        fragLoadingTimeOut: 15000,
        manifestLoadingTimeOut: 8000,
        levelLoadingTimeOut: 8000,
        fragLoadingMaxRetry: 3,
        manifestLoadingMaxRetry: 2,
        levelLoadingMaxRetry: 2,
        startFragPrefetch: true
    });
    
    hlsInstance.on(Hls.Events.MANIFEST_PARSED, function() {
        showSpinner(false);
        video.muted = false;
        video.volume = 1.0;
        video.play().catch(function() {
            video.muted = true;
            video.play().then(function() {
                setTimeout(function() { video.muted = false; }, 500);
            });
        });
    });
    
    hlsInstance.on(Hls.Events.ERROR, function(event, data) {
        if (data.fatal) {
            showSpinner(false);
            if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                setTimeout(function() { 
                    if (hlsInstance) hlsInstance.startLoad(); 
                }, 1000);
            } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
                hlsInstance.recoverMediaError();
            } else {
                showError('Error al cargar el stream');
            }
        }
    });
    
    hlsInstance.loadSource(url);
    hlsInstance.attachMedia(video);
}

function playDirect(url) {
    video.src = url;
    video.addEventListener('canplay', function onCanPlay() {
        showSpinner(false);
        video.play();
        video.removeEventListener('canplay', onCanPlay);
    });
    video.addEventListener('error', function onError() {
        showSpinner(false);
        showError('Error al reproducir');
        video.removeEventListener('error', onError);
    });
}

function filterChannels(query) {
    var q = query.toLowerCase().trim();
    
    if (!q) {
        filteredChannels = [];
        if (currentCategory === 'all') {
            renderChannels(channels);
        } else {
            var filtered = [];
            for (var i = 0; i < channels.length; i++) {
                if (channels[i].group === currentCategory) filtered.push(channels[i]);
            }
            renderChannels(filtered);
        }
        return;
    }
    
    filteredChannels = [];
    for (var i = 0; i < channels.length; i++) {
        var ch = channels[i];
        var matchCat = currentCategory === 'all' || ch.group === currentCategory;
        var matchQuery = ch.name.toLowerCase().indexOf(q) !== -1 || ch.group.toLowerCase().indexOf(q) !== -1;
        if (matchCat && matchQuery) filteredChannels.push(ch);
    }
    
    renderChannels(filteredChannels);
}

searchInput.oninput = function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(function() {
        filterChannels(searchInput.value);
    }, 100);
};

categorySelect.onchange = function() {
    filterByCategory(categorySelect.value);
};

function updateFocus(items) {
    searchInput.classList.remove('nav-focused');
    for (var i = 0; i < items.length; i++) {
        if (i === focusedIndex) {
            items[i].classList.add('focused');
            items[i].scrollIntoView({ block: 'center', behavior: 'auto' });
        } else {
            items[i].classList.remove('focused');
        }
    }
}

document.onkeydown = function(e) {
    var isSearchActive = document.activeElement === searchInput;
    var isCategoryActive = document.activeElement === categorySelect;
    var items = document.querySelectorAll('.channel-item');
    var itemsArray = Array.prototype.slice.call(items);
    
    if (isSearchActive || isCategoryActive) {
        if (e.key === 'ArrowDown' && items.length > 0) {
            e.preventDefault();
            searchInput.blur();
            categorySelect.blur();
            focusedIndex = 0;
            updateFocus(itemsArray);
        } else if (e.key === 'Escape') {
            e.preventDefault();
            if (isSearchActive && searchInput.value) {
                searchInput.value = '';
                filterChannels('');
            }
            searchInput.blur();
            categorySelect.blur();
        }
        return;
    }
    
    switch(e.key) {
        case 'ArrowUp':
            e.preventDefault();
            if (sidebarVisible && !isInFullscreen) {
                if (focusedIndex <= 0) {
                    categorySelect.focus();
                    for (var i = 0; i < items.length; i++) items[i].classList.remove('focused');
                    focusedIndex = -1;
                } else {
                    focusedIndex--;
                    updateFocus(itemsArray);
                }
            } else {
                channelUp();
            }
            break;
        case 'ArrowDown':
            e.preventDefault();
            if (sidebarVisible && items.length > 0 && !isInFullscreen) {
                focusedIndex = Math.min(items.length - 1, focusedIndex + 1);
                if (focusedIndex < 0) focusedIndex = 0;
                updateFocus(itemsArray);
            } else {
                channelDown();
            }
            break;
        case 'ArrowLeft':
            e.preventDefault();
            if (sidebarVisible) {
                categorySelect.focus();
            } else if (!isInFullscreen) {
                toggleSidebar();
            }
            break;
        case 'ArrowRight':
            e.preventDefault();
            if (sidebarVisible && !isInFullscreen) {
                toggleSidebar();
            }
            break;
        case 'Enter':
            e.preventDefault();
            if (sidebarVisible && focusedIndex >= 0 && items[focusedIndex]) {
                var id = parseInt(items[focusedIndex].dataset.id);
                for (var j = 0; j < channels.length; j++) {
                    if (channels[j].id === id) {
                        playChannel(channels[j]);
                        break;
                    }
                }
            }
            break;
        case 'Escape':
            e.preventDefault();
            if (isInFullscreen) exitFullscreen();
            else if (!sidebarVisible) toggleSidebar();
            break;
        case ' ':
            e.preventDefault();
            if (video.paused) video.play(); else video.pause();
            break;
        case 'f':
        case 'F':
            e.preventDefault();
            toggleFullscreen();
            break;
        case 's':
        case 'S':
        case '/':
            if (sidebarVisible && !isInFullscreen) {
                e.preventDefault();
                searchInput.focus();
            }
            break;
        case 'c':
        case 'C':
            if (sidebarVisible && !isInFullscreen) {
                e.preventDefault();
                categorySelect.focus();
            }
            break;
    }
};

searchInput.onfocus = function() { searchInput.classList.add('nav-focused'); };
searchInput.onblur = function() { searchInput.classList.remove('nav-focused'); };

function toggleFullscreen() {
    if (!document.fullscreenElement) enterFullscreen();
    else exitFullscreen();
}

function enterFullscreen() {
    var elem = document.documentElement;
    if (elem.requestFullscreen) elem.requestFullscreen();
    else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
}

function exitFullscreen() {
    if (document.exitFullscreen) document.exitFullscreen();
    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
}

function handleFullscreenChange() {
    if (document.fullscreenElement || document.webkitFullscreenElement) {
        isInFullscreen = true;
        document.body.classList.add('fullscreen-active');
        video.removeAttribute('controls');
    } else {
        isInFullscreen = false;
        document.body.classList.remove('fullscreen-active');
        video.removeAttribute('controls');
    }
}

document.addEventListener('fullscreenchange', handleFullscreenChange);
document.addEventListener('webkitfullscreenchange', handleFullscreenChange);

video.onwaiting = function() { showSpinner(true); };
video.onplaying = function() { showSpinner(false); };
video.ondblclick = function(e) { e.preventDefault(); toggleFullscreen(); };

document.getElementById('toggleSidebar').onclick = toggleSidebar;
document.getElementById('btnUp').onclick = channelUp;
document.getElementById('btnDown').onclick = channelDown;
document.getElementById('btnFs').onclick = toggleFullscreen;

loadPlaylist();
</script>
</body>
</html>

